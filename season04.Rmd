---
title: "Netrunnerliga Bremen - Season 4"
date: "`r ddateR::poee()`"
output:
  html_document
---

```{r, init, echo = F, warning = F, message = F}
source(paste0(Sys.getenv("PROJECT_HOME"), "./init.R"))
knitr::opts_chunk$set(fig.path = "assets/liga-plots/04")

s4 <- readRDS("./data/Liga.rds")
```


## Punktestand

```{r Punktestand}
# try to replicate with new structure
## this gives accurate table of standings
s4 %>% 
  gather(Seite, Spieler, Konzern_Player, Runner_Player) %>% 
  mutate(Punkte = ifelse(Sieger_Spieler == Spieler, 3, 0)) %>% 
  group_by(Spieler) %>% 
  summarise(Spiele       = n() / 2,
            Agendapunkte = sum(Runner_Agendapunkte + Konzern_Agendapunkte),
            Gesamtpunkte = sum(Punkte)) %>% 
  arrange(desc(Gesamtpunkte), desc(Agendapunkte)) %>% 
  knitr::kable()
```

## Gespielte Matches

```{r Spiele}
## this gives accurate table of played games
# ftable(table(s4$Konzern_Player, s4$Runner_Player))

# try to reproduce fancy table from old seasons, but dynamically
yesno <- formatter("span", style = x ~ style(color = ifelse(x, "green", "red")),
                   x ~ icontext(ifelse(x, "ok", "remove")))

games <- as.data.frame.matrix(
  !!table(s4$Konzern_Player, s4$Runner_Player)
  )

format_table(games,
             # this needs a more adaptive solution...
             list(Aschkan = yesno, Boray = yesno, Falk = yesno, Jan    = yesno, 
                  Josh    = yesno, Kai   = yesno, Paul = yesno, Stefan = yesno,
                  Tobi    = yesno
                  # Ole = yesno, Johannes = yesno
                  ),
             row.names = T, align = "c"
             )
```


## Spielhäufigkeiten

### nach Fraktion

```{r Fraktionen}
data.frame(
    Seite    = c(rep("Konzern", length(s4$Konzern_Player)), 
                 rep("Runner", length(s4$Runner_Player))),
    Fraktion = c(s4$Konzern_Fraktion, s4$Runner_Fraktion)
) %>% 
  ggplot(aes(x = Fraktion, fill = Fraktion, color = Fraktion)) +
    geom_bar(alpha = .4) +
    scale_fill_manual(values = all_colors) +
    scale_color_manual(values = all_colors) +
    labs(x = "", y = "Spiele") +
    facet_wrap(~Seite, scales = "free_x", ncol = 2) +
    theme(legend.position = "none")
```

### nach ID

```{r IDs_Konzern}
ggplot(s4, aes(x = Konzern_ID, 
                  fill = Konzern_Fraktion, color = Konzern_Fraktion)) +
  geom_bar(alpha = 0.4) +
  scale_fill_manual(values = kon_colors) +
  scale_color_manual(values = kon_colors) +
  labs(x = "", y = "Spiele") +
  facet_wrap(~Konzern_Fraktion, scales = "free_x", ncol = 4) +
  theme(axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1),
        legend.position = "none")
```

```{r IDs_Runner}
ggplot(s4, aes(x = Runner_ID, 
                  fill = Runner_Fraktion, color = Runner_Fraktion)) +
  geom_bar(alpha = 0.4) +
  scale_fill_manual(values = run_colors) +
  scale_color_manual(values = run_colors) +
  labs(x = "", y = "Spiele") +
  facet_wrap(~Runner_Fraktion, scales = "free_x", ncol = 4) +
  theme(axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1),
        legend.position = "none")
```

## Runs

### Runs pro Spieler

Der graue Balken ist die durchschnittliche Anzahl Runs über alle Spieler hinweg und die schwarzen Balken sind entsprechend der Durchschnitt der jeweiligen Person.

```{r Runs_Spieler}
ggplot(s4, aes(x = Runner_Player, y = Runs, color = Runner_Player)) +
  geom_hline(yintercept = mean(s4$Runs, na.rm = T), 
             size = 1, color = "gray") +
  stat_summary(fun.y = "mean", fun.ymax = "mean", fun.ymin = "mean", 
               colour = "black", size = 0.5, geom = "errorbar") +
  geom_jitter() +
  labs(x = NULL, y = "Runs") + 
  theme(legend.position = "none")
```