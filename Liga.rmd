---
title: "Netrunnerliga"
author: "Tobias Anton"
date: "`r ddateR::poee()`"
output:
  rmdformats::html_clean:
    self_contained: no
    lib_dir: "assets"  
    css: style.css
    fig_width: 10
    dpi: 360
    highlight: tango
    theme: spacelab
---

```{r, message=F, warning=FALSE, include=FALSE}
source(paste0(Sys.getenv("PROJECT_HOME"), "./init.r"))
knitr::opts_chunk$set(echo = F, fig.path = "plots/", warning = F, message = F)
```

# Aktuelle Liga

## Punktestand

Wer mehr als 80% seiner Spiele schon hinter sich hat, bekommt ne grüne Zahl. Bei weniger als 50%, erscheint ne rote.

```{r, Punktestand, echo = F, warning = F, message = F}
  liga %>% 
    filter(Saison == 2) %>% 
    group_by(Spieler) %>% 
    summarize(Spiele       = n()/2,
              Agendapunkte = sum(Agendapunkte),
              Punkte       = sum(Punkte)) %>%
    arrange(desc(Punkte), desc(Agendapunkte)) %>% 
    format_table(list(
                  Punkte = color_tile("white", "lightblue"),
                  Agendapunkte = color_tile("white", "lightgray"),
                  Spiele = formatter("span",
                                     style = x ~ style(color = ifelse(x <= 4, "red", 
                                                               ifelse(x >= 7, "green", "gray")))
                      )),
      check.rows = F, format = "pandoc")
```

## Spiel"übersicht"

Sieht zur Zeit *(Prickle-Prickle, 6th Day of Discord)* reichlich schräg aus...

```{r Spiele}
games <- liga %>% 
  filter(Saison == 2, Runde == 1) %>% 
  select(Spiel, Spieler)

games <- table(games$Spiel, games$Spieler)

games <- as.data.frame.matrix(!!crossprod(games))

# games <- games %>% mutate(vs = rownames(.))

yesno <- formatter("span", style = x ~ style(color = ifelse(x, "green", "red")),
                                   x ~ icontext(ifelse(x, "ok", "remove")))

    format_table(games, 
      list(Bjarne = yesno, Bodo = yesno, Falk = yesno,
           Jan = yesno, Johannes = yesno, Josh = yesno,
           Kai = yesno, Paul = yesno, Tobias = yesno), 
      check.rows = T, align = "c", format = "markdown")
```

### Moar (irrelevante) Tabellen!

```{r sidestat}
liga %>% 
  filter(Saison == 2) %>% 
  group_by(Spieler) %>% 
  summarize(Spiele = n()/2,
            "Agendapunkte / Spiel" = sum(Agendapunkte, na.rm = T) / (n()/2),
            "Punkte pro Spiel"     = sum(Punkte, na.rm = T) / (n()/2))
            # Kills  = count(filter(Saison == 2, Siegbedingung == "Flatline"), Spieler))
```

# "Ewige" Liga

## Spielhäufigkeiten

### nach Fraktion

```{r, IDs, echo = F}
  ggplot(liga, aes(x = Fraktion, fill = Fraktion)) +
    geom_bar(color = "black") +
    labs(x = "", y = "Spiele") +
    facet_grid(. ~ Seite, scales = "free_x") +
    scale_fill_manual(values = c("darkorange", "deepskyblue3", "darkorchid4", "red", "gold1", 
                                 "darkgray", "chartreuse3", "darkolivegreen")) +
    cosmetics +
    theme(legend.position = "none")
```
  
### nach ID

```{r, IDs_Konzern, echo = F}
  liga %>% 
    filter(Seite == "Konzern") %>% 
    ggplot(aes(x = ID, fill = Fraktion)) +
      geom_bar(color = "black") +
      labs(x = "", y = "Spiele", legend = "") +
      facet_grid(. ~ Fraktion, scales = "free") +
      scale_fill_manual(values = c("darkorchid4", "red", "gold1", "darkolivegreen")) +
      cosmetics +
      theme(axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1),
            legend.position = "none")
```

```{r, IDs_Runner, echo = F}
  liga %>% 
    filter(Seite == "Runner") %>% 
    ggplot(aes(x = ID, fill = Fraktion)) +
      geom_bar(color = "black") +
      labs(x = "", y = "Spiele") +
      facet_grid(. ~ Fraktion, scales = "free") +
      scale_fill_manual(values = c("darkorange", "deepskyblue3", "darkgray", "chartreuse3")) +
      cosmetics +
      theme(axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1),
            legend.position = "none")
```
  
## Runs

### Runs pro Spieler

Der graue Balken ist die durchschnittliche Anzahl Runs über alle Spieler hinweg und die schwarzen Balken sind entsprechend der Durchschnitt der jeweiligen Person.

```{r, Runs_Spieler, warning = F, echo = F}
ggplot(liga, aes(x = Spieler, y = Runs, color = Spieler)) +
  geom_point(position = "jitter") +
  stat_summary(fun.y = "mean", fun.ymax = "mean", fun.ymin = "mean", 
               colour = "black", size = 0.5, geom = "errorbar") +
  geom_hline(yintercept = mean(liga$Runs, na.rm = T), size = 1, color = "gray") +
  labs(x = NULL, y = "Runs") + 
  scale_color_brewer(palette = "Set1") +
  cosmetics + theme(legend.position = "none")
```

### Runs pro Fraktion

Das ergibt einen seltsamen Dichteplot, der erst sinnvoll ist, sobald einiges an Daten angefallen ist (Nachtrag mitten in Season 2: so jetzt halt in etwa).

```{r, Runs_Fraktion, warning = F, echo = F}
  liga %>%
    filter(Seite == "Runner", Fraktion != "Neutral") %>%
    ggplot(aes(x = Runs, fill = Fraktion)) +
      geom_density(aes(y = ..count..), alpha = 0.7) +
      labs(x = "Runs",
           y = "") +
      run_fill + cosmetics
```

### Runs pro ID

Ganz schön unübersichtlich, ich überleg mir mal was neues...

```{r, Runs_ID, warning = F, echo = F}
  liga %>%
    filter(Seite == "Runner") %>%
    ggplot(aes(x = Fraktion, y = Runs, color = ID)) +
      geom_point(size = 4, color = "black") +
      geom_point(size = 3) +
      labs(x = NULL, y = "Runs") +
      scale_color_viridis(discrete = T) +
      cosmetics
```

### Runs auf Systeme

```{r, eval=FALSE, include=FALSE, runs_server_alt, warning=F}
  liga %>%
    filter(Seite == "Runner") %>%
    gather(Server, Anzahl, `R&D`, HQ, Archiv, Remote) %>%
    ggplot(aes(x = Server, y = Anzahl, fill = Spieler)) +
      geom_bar(stat = "identity", position = "dodge", color = "black") +
      scale_fill_brewer(palette = "Set1") +
      labs(x = "",
           y = "Runs") +
      cosmetics
```

```{r runs_server}
liga %>% 
  filter(Seite == "Runner", Spieler != "Jannis") %>% 
  gather(Systeme, Runzahl, Archiv, `R&D`, HQ, Remote) %>% 
  ggplot(., aes(x = Spieler, y = Systeme, fill = Runzahl)) + 
    geom_tile(color = "white", size = 0.4) +
    labs(title = "Runs pro Spieler und System",
         x = NULL, y = NULL) +
    scale_fill_viridis(option = "D") +
    cosmetics + 
    theme(legend.position = "bottom")
```

# Analyse
#### Willkommen bei Methodisch Inkorrekt

Hier beginnt der eigentliche Spaß. Also für mich zumindest. To the research! /o/  
Disclaimer: p-Werte! Sind sie nicht einfach herzallerliebst? Man muss unsere albernen, kleinen p-Werte einfach lieben. Will sagen: Die haben hier noch viel weniger Aussagekraft als sowieso schon, aber ich benutz sie hier trotzdem ganz regulär. For the lulz.


## Siege

#### Welcome to Corp Town

```{r Corp_vs_Runner}
liga %>% 
  group_by(Seite) %>% 
  summarize(Siege = sum(Punkte)/2)
```

#### Brauchen wir eine bedingungslose Plascreteversorgung?

```{r Siegbedingung}
sieg_tbl <- liga %>% filter(Seite == "Konzern", Punkte == 2)

  ggplot(sieg_tbl, aes(x = Siegbedingung, fill = Siegbedingung)) +
    geom_bar(color = "black") +
    labs(y = "Siege") +
    scale_fill_brewer(palette = "Set1") +
    cosmetics + theme(legend.position = "none")

chisq_sieg <- sjt.xtab(sieg_tbl$Siegbedingung, sieg_tbl$Fraktion,
                       no.output = T, useViewer = F)
```

Sieht eigentlich ganz gesund aus; Konzerne gewinnen öfter durch Punkte. Schauen wir uns das mal genauer an:

```{r chisq_sieg_plot}
ggplot(sieg_tbl, aes(x = Siegbedingung, fill = Fraktion)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), position = "dodge", color = "black") +
  labs(y = "Siege (%)") +
  scale_y_continuous(labels = percent) +
  kon_fill + cosmetics
```
  
`r chisq_sieg$knitr`  

Nunja. Weyland tut, was Weyland tut, aber ansonsten scheint es nur den ein oder anderen Butchershop o.ä. zu geben. Unser p liegt bei etwa `r round(fisher.test(sieg_tbl$Siegbedingung, sieg_tbl$Fraktion)$p.value, 3)` (mit durchaus nennenswerter Effektgröße), d.h. in diesem Fall sogar, dass wir ne relativ kuschelige Liga haben. Abgesehen, wie gesagt, von Weyland. Bei Weyland wird nicht gekuschelt.


## Spieldauer

#### thinking hard, then drawing a card, then thinking hard for another 5 minutes

Geht wieder los mit Daten angucken:

```{r Spieldauer_tbl}
dauer <- liga %>% 
  filter(Spieler != "Jannis") %>% 
  group_by(Spieler) %>% 
  summarize("Min / Runde"  = round(mean(Dauer / Runden, na.rm = T), 2), 
            "Dauer (Min.)" = round(mean(Dauer, na.rm = T), 0))
 
  formattable(dauer, list(
    `Min / Runde`  = color_tile("white", "orange"),
    `Dauer (Min.)` = color_tile("white", "lightblue")
  ))
```

Das Volk staunt! Mehr oder weniger. Vermutlich weniger... Aber gucken wir doch mal, ob das auch ein nennenswerter Unterschied ist. Der geneigte Humanwissenschaftler käme jetzt eventuell auf die Idee, da eine ANOVA zu machen:

```{r Spieldauer_aov}
library(tadaatoolbox)

model <- aov(Dauer ~ Spieler, liga)
tadaa_aov(model, liga, print = "markdown")
```

Stellt sich raus: scrollen Sie weiter, es gibt nichts zu sehen.  

*Fortsetzung folgt*


## Korrelationen (here be dragons)

Ist natürlich Quatsch, aber vllt. fällt mir da nochmal was interessantes ein... m)

### Runden und Spieldauer

Ist noch eher suboptimal; da halt immer zwei Leute ein Spiel spielen liegen jeweils zwei Leute auf einem Punkt. Vielleicht in zwei Plots teilen:  
1. Runden/Dauer nach Spieler (**Konzern**)  
2. Runden/Dauer nach Spieler (**Runner**)  

```{r, Runden_Dauer, echo = F}
  liga %>% 
    filter(is.na(Runs)) %>% 
    ggplot(aes(x = Dauer, y = Runden, color = Spieler)) +
      geom_point(size = 4, color = "black") +
      geom_point(size = 3) +
      # geom_smooth(method = "lm", se = F) +
      labs(x = "Spieldauer (Minuten)",
           y = "Runden") +
      cosmetics
```

### Runden und Runs

```{r, Runden_Runs, echo = F}
  liga %>%
    filter(Seite == "Runner") %>%
    ggplot(aes(x = Runden, y = Runs, color = Fraktion)) +
      geom_point(size = 4, color = "black") +
      geom_point(size = 3) +
      geom_smooth(method = "lm", se = F) +
      scale_color_manual(values = c("darkorange", "deepskyblue3", "darkgray", "chartreuse3")) +
      labs(x = "Runden",
           y = "Runs") +
      cosmetics
```
