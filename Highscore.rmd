---
title: "Highscoreliste Highlander Games Bremen"
author: "Tobias Anton"
date: "`r ddateR::poee()`"
output:
  rmdformats::html_clean:
    css: style.css
    fig_width: 10
    dpi: 360
    highlight: tango
    theme: spacelab
    self_contained: no
    lib_dir: "assets"
---

```{r, message=F, warning=FALSE, include=FALSE}
source(paste0(Sys.getenv("PROJECT_HOME"), "./init.R"))
knitr::opts_chunk$set(echo = F, fig.path = "highscore-plots/", warning = F, message = F)
```

# Arena Highscore-Liste

Während ein Ligaspiel aus zwei Runden besteht (jede/r SpielerIn je einmal Kon **und** Runner) wird hier eine Runde bereits als ganzes Spiel gezählt (entweder Kon **oder** Runner).

```{r, Die_Liste}
  score %>% 
    group_by(Spieler) %>% 
    summarize("Spiele" = n(),
              "Siege"  = sum(Punkte)/2,
              "Ratio"  = percent((sum(Punkte)/2)/Spiele, 1)) %>%
    arrange(desc(Ratio), desc(Siege), Spiele) %>% 
    format_table(list(
      Spiele = color_tile("white", "lightgreen"),
      check.rows = F, format = "pandoc"))
```

## Spielübersicht

"Übersicht". x)

```{r Spieluebersicht}
as.data.frame.matrix(crossprod(table(score$Spiel, score$Spieler))) %>% 
  gather(Spieler, Spiele, Bjarne, Bodo, Boray, Falk, Jan,
         Johannes, Josh, `Josh R.`, Kai, Ole, Paul, Tobias) %>% 
  mutate(Gegner = rep(c("Bjarne", "Bodo", "Boray", "Falk", "Jan",
                        "Johannes", "Josh", "Josh R.", 
                        "Kai", "Ole", "Paul", "Tobias"), 12)) %>% 
  filter(Spieler != Gegner, Spiele != 0) %>% 
  ggplot(., aes(x = Spieler, y = Gegner, fill = Spiele)) + 
    geom_tile(color = "white", size = 0.5) +
    geom_text(aes(label = Spiele), color = "white") +
    labs(x = NULL, y = NULL) +
    scale_fill_viridis(option = "B") +
    cosmetics + theme(legend.position = "top")
```

## Siege pro Woche pro Spieler (pro ID)

Durch klicken auf die Namen in der Legende und in der oberen Leiste bekommt man das etwas übersichtlicher; an brauchbaren Defaults arbeite ich noch...

```{r WochenspielerIDsiege, eval = F}
  score %>%
    group_by(Kalenderwoche, Spieler) %>% 
    summarize("Wins" = sum(Punkte)/2,
              "IDs"  = paste(unique(ID), collapse = ",")) %>%
    plot_ly(., x = Kalenderwoche, y = Wins, line = list(shape = "spline"),
            color = Spieler, text = str_replace_all(IDs, ",", "<br />"))
```

## Siege nach Seite

### Allgemein

```{r, Seitenliste}
  score %>% 
    group_by(Seite) %>% 
    summarize("Spiele" = n(),
              "Siege" = sum(Punkte)/2,
              "Ratio" = percent((sum(Punkte)/2)/Spiele, 1)) %>%
    arrange(Spiele) %>% 
    arrange(desc(Siege)) %>%
    arrange(desc(Ratio)) %>% 
    knitr::kable()
```

### Pro Spieler

```{r SeiteproSpieler}
wins <- score %>% 
  group_by(Seite, Spieler) %>% 
  summarize(Spiele  = n(),
            Siege   = sum(Punkte)/2,
            Prozent = round(Siege / Spiele * 100, 1)) %>% 
  mutate(Prozent = ifelse(Seite == "Konzern", Prozent * -1, Prozent * 1))



ggplot(wins, aes(x = Spieler, color = Seite)) +
  geom_linerange(data = wins[wins$Seite == "Runner", ],
                 aes(ymin = 10, ymax = 10 + Prozent), size = 12, alpha = 0.8) +
  
  geom_linerange(data = wins[wins$Seite == "Konzern", ],
                 aes(ymin = -10, ymax = -10 + Prozent), size = 12, alpha = 0.8) +
  
  geom_label(aes(x = Spieler, y = 0, label = Spieler, family = "sans"), 
             inherit.aes = F, size = 5, label.padding = unit(0.0, "lines"), 
             label.size = 0, label.r = unit(0.0, "lines"), color = "black") +
  
  scale_y_continuous(breaks = c(c(-100, -80, -60, -40, -20, 0) + -10, 
                                c(0, 20, 40, 60, 80, 100) + 10),
                     labels = c("100%", "80%", "60%", "40%", "20%", "0%",
                                "0%", "20%", "40%", "60%", "80%", "100%")) +
  
  labs(x = NULL, y = NULL, title = "Siege pro Spieler pro Seite") +
  
  scale_color_manual(name = "", values = c(Konzern = "#3288bd", Runner = "#d53e4f"),
                     labels = c("Konzern", "Runner")) +
  
  theme_hc() + coord_flip() + 
  theme(axis.text.y   = element_blank(), panel.grid.major.x = element_line(color = "gray"),
        axis.ticks.y  = element_blank(), panel.grid.major.y = element_blank(),
        legend.position = "top", title = element_text(size = 14), axis.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text  = element_text(size = 10),
        strip.text   = element_text(size = 14))
```


## Siege nach Fraktion

### Konzerne

```{r, Fraktionsliste_Konzerne}
  score %>% 
    filter(Seite == "Konzern") %>% 
    group_by(Fraktion) %>% 
    summarize("Spiele" = n(),
              "Siege" = sum(Punkte)/2,
              "Ratio" = percent((sum(Punkte)/2)/Spiele, 1)) %>%
    arrange(Spiele) %>% 
    arrange(desc(Siege)) %>%
    arrange(desc(Ratio)) %>% 
    knitr::kable()
```

### Runner

```{r, Fraktionsliste_Runner}
  score %>% 
    filter(Seite == "Runner") %>% 
    group_by(Fraktion) %>% 
    summarize("Spiele" = n(),
              "Siege" = sum(Punkte)/2,
              "Ratio" = percent((sum(Punkte)/2)/Spiele, 1)) %>%
    arrange(Spiele) %>% 
    arrange(desc(Siege)) %>%
    arrange(desc(Ratio)) %>% 
    knitr::kable()
```


## Spielhäufigkeiten

### nach Fraktion

```{r, IDs, echo = F}
  ggplot(score, aes(x = Fraktion, fill = Fraktion)) +
    geom_bar(color = "black") +
    labs(x = "", y = "Spiele") +
    facet_grid(. ~ Seite, scales = "free_x") +
    faction_fill +
    cosmetics +
    theme(legend.position = "none")
```
  
### nach ID

```{r, IDs_Konzern, echo = F}
  score %>% 
    filter(Seite == "Konzern") %>% 
    ggplot(aes(x = ID, fill = Fraktion)) +
      geom_bar(color = "black") +
      labs(x = "", y = "Spiele", legend = "") +
      facet_grid(. ~ Fraktion, scales = "free") +
      kon_fill +
      cosmetics +
      theme(axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1),
            legend.position = "none")
```

```{r, IDs_Runner, echo = F}
  score %>% 
    filter(Seite == "Runner") %>% 
    ggplot(aes(x = ID, fill = Fraktion)) +
      geom_bar(color = "black") +
      labs(x = "", y = "Spiele") +
      facet_grid(. ~ Fraktion, scales = "free") +
      run_fill +
      cosmetics +
      theme(axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1),
            legend.position = "none")
```


## Präferenzen

Wer spielt was am liebsten? Ne richtige Analyse ist grad nicht machbar (die Neuen haben noch zu wenig Spiele... :D), aber man kann durchaus Trends erkennen.  
Die blau/grüne Zahl gibt an, wie oft eine Fraktion gespielt würde, wenn keine Präferenz vorläge.

```{r Praeferenzen}
pref_runner  <- sjt.xtab(runner_score$Spieler, runner_score$Fraktion, title = "Runner",
                         showExpected = T, showSummary = F, highlightTotal = T,
                         no.output = T, useViewer = F)

pref_konzern <- sjt.xtab(konzern_score$Spieler, konzern_score$Fraktion, title = "Konzerne",
                         showExpected = T, showSummary = F, highlightTotal = T,
                         no.output = T, useViewer = F)
```

<div class = "col2">
`r pref_runner$knitr` <br />
`r pref_konzern$knitr`
</div>


## A Plascrete in your deck keeps the Flatline in check. Oder so.
Kuschel-Corps oder Butchershops?

```{r Siegbedingungen_Kons}
chisq_sieg <- sjt.xtab(konzern_score$Fraktion, konzern_score$Siegbedingung,
                       title = "Konzernsiege", showExpected = T, highlightTotal = T,
                       no.output = T, useViewer = F)
```

<div align = "center">
`r chisq_sieg$knitr`
</div>

Nicht nur, dass Jinteki (!) mehr Flatlines als reguläre Siege hat[^1], nein, sogar Haas-Bioroid hat schon den ein oder anderen Flatline bewerkstelligt. Unsere Meta ist kein gemütlicher Ort für Runner...

#### Und in bunt:

```{r Siegbedingungen_Kons_plot}
konzern_score %>% 
  filter(!is.na(Siegbedingung)) %>% 
  ggplot(., aes(x = Fraktion, group = Siegbedingung)) + 
    geom_bar(position = "dodge", color = "black", fill = c(
      "#341145", "#864EA2", "#990000", "#ff4c4c", 
      "#B29600", "#ffe34c", "#2a3517", "#768858")) +
      labs(y = "Siege", x = NULL) +
      annotate("text", x = 3.75, y = 27, size = 5,
               label = "hell = Punktsieg \ndunkel = Flatline") +
      # scale_y_continuous(labels = percent) +
      kon_fill + cosmetics
```

[^1]: Ist für Jinteki jetzt nicht *soo* ungewöhnlich, aber bei den Häufigkeiten sehen wir ja, dass hauptsächlich RP, Palana und IG gespielt werden. Also IDs, die nicht unbedingt den Flatline als Plan A haben.